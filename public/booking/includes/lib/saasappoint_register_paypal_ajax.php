<?php session_start();/* Include class files */include(dirname(dirname(dirname(__FILE__)))."/constants.php");include(dirname(dirname(dirname(__FILE__)))."/classes/class_connection.php");include(dirname(dirname(dirname(__FILE__)))."/classes/class_settings.php");include(dirname(dirname(dirname(__FILE__)))."/classes/class_admins.php");include(dirname(dirname(dirname(__FILE__)))."/classes/class_subscriptions.php");include(dirname(dirname(dirname(__FILE__)))."/classes/class_subscription_plans.php");include(dirname(dirname(dirname(__FILE__)))."/classes/class_businesses.php");include(dirname(dirname(dirname(__FILE__)))."/classes/class_schedule.php");include(dirname(dirname(dirname(__FILE__)))."/classes/class_frequently_discount.php");include(dirname(dirname(dirname(__FILE__)))."/classes/class_templates.php");include(dirname(dirname(dirname(__FILE__)))."/includes/payments/paypal/saasappoint_paypal_express_checkout.php");/* Create object of classes */$obj_database = new saasappoint_database();$conn = $obj_database->connect();$obj_settings = new saasappoint_settings();$obj_settings->conn = $conn;$obj_admins = new saasappoint_admins();$obj_admins->conn = $conn;$obj_subscription_plans = new saasappoint_subscription_plans();$obj_subscription_plans->conn = $conn;$obj_subscriptions = new saasappoint_subscriptions();$obj_subscriptions->conn = $conn;$obj_businesses = new saasappoint_businesses();$obj_businesses->conn = $conn;$obj_schedule = new saasappoint_schedule();$obj_schedule->conn = $conn;$obj_frequently_discount = new saasappoint_frequently_discount();$obj_frequently_discount->conn = $conn;$obj_templates = new saasappoint_templates();$obj_templates->conn = $conn;/** Register admin freeplan Ajax **/if(isset($_POST['register_admin_paypal'])){	$obj_subscription_plans->id = $_POST['plan_id'];	$plan_detail = $obj_subscription_plans->readone_subscription_plan();		if($plan_detail['renewal_type'] == "monthly"){		$date_year_month = "months";		$year_month = "Month";	}else{		$date_year_month = "years";		$year_month = "Year";	}	if($plan_detail['plan_period'] > 1){ 		$plan_period_detail = $plan_detail['plan_period']." ".$year_month."s"; 	}else{ 		$plan_period_detail = $plan_detail['plan_period']." ".$year_month; 	}		$saasappoint_settings_timezone = $obj_settings->get_superadmin_option("saasappoint_timezone");	$saasappoint_server_timezone = date_default_timezone_get();	$currDateTime_withTZ = $obj_settings->get_current_time_according_selected_timezone($saasappoint_server_timezone,$saasappoint_settings_timezone); 		$subscribed_date = date("Y-m-d H:i:s", $currDateTime_withTZ);	$exipred_date = date("Y-m-d H:i:s", strtotime("+".$plan_detail['plan_period']." ".$date_year_month, strtotime($subscribed_date)));		$description = ucwords($_POST['firstname']." ".$_POST['lastname'])." (".$_POST['phone'].") subscribed for subscription plan: ".ucwords($plan_detail['plan_name'])." - [".$plan_period_detail."]";		$updated_sms_credit = $plan_detail['sms_credit'];		$_SESSION["saasappoint_adminregister_detail"] = array();	$_SESSION["saasappoint_adminregister_detail"]["plan_id"] = $_POST["plan_id"];	$_SESSION["saasappoint_adminregister_detail"]["firstname"] = $_POST["firstname"];	$_SESSION["saasappoint_adminregister_detail"]["lastname"] = $_POST["lastname"];	$_SESSION["saasappoint_adminregister_detail"]["email"] = $_POST["email"];	$_SESSION["saasappoint_adminregister_detail"]["password"] = $_POST["password"];	$_SESSION["saasappoint_adminregister_detail"]["phone"] = $_POST["phone"];	$_SESSION["saasappoint_adminregister_detail"]["business_type_id"] = $_POST["business_type_id"];	$_SESSION["saasappoint_adminregister_detail"]["address"] = $_POST["address"];	$_SESSION["saasappoint_adminregister_detail"]["city"] = $_POST["city"];	$_SESSION["saasappoint_adminregister_detail"]["state"] = $_POST["state"];	$_SESSION["saasappoint_adminregister_detail"]["zip"] = $_POST["zip"];	$_SESSION["saasappoint_adminregister_detail"]["country"] = $_POST["country"];	$_SESSION["saasappoint_adminregister_detail"]["companyname"] = $_POST["companyname"];	$_SESSION["saasappoint_adminregister_detail"]["companyemail"] = $_POST["companyemail"];	$_SESSION["saasappoint_adminregister_detail"]["companyphone"] = $_POST["companyphone"];	$_SESSION["saasappoint_adminregister_detail"]["companyaddress"] = $_POST["companyaddress"];	$_SESSION["saasappoint_adminregister_detail"]["companycity"] = $_POST["companycity"];	$_SESSION["saasappoint_adminregister_detail"]["companystate"] = $_POST["companystate"];	$_SESSION["saasappoint_adminregister_detail"]["companyzip"] = $_POST["companyzip"];	$_SESSION["saasappoint_adminregister_detail"]["companycountry"] = $_POST["companycountry"];	$_SESSION["saasappoint_adminregister_detail"]["updated_sms_credit"] = $updated_sms_credit;	$_SESSION["saasappoint_adminregister_detail"]["renewal_type"] = $plan_detail["renewal_type"];	$_SESSION["saasappoint_adminregister_detail"]["description"] = $description;	$_SESSION["saasappoint_adminregister_detail"]["exipred_date"] = $exipred_date;	$_SESSION["saasappoint_adminregister_detail"]["subscribed_date"] = $subscribed_date;	$_SESSION["saasappoint_adminregister_detail"]["plan_rate"] = $plan_detail["plan_rate"];	$_SESSION["saasappoint_adminregister_detail"]["plan_name"] = $plan_detail["plan_name"];}$saasappoint_paypal_guest_payment = $obj_settings->get_superadmin_option('saasappoint_paypal_guest_payment');$saasappoint_paypal_api_username = urlencode($obj_settings->get_superadmin_option('saasappoint_paypal_api_username'));$saasappoint_paypal_api_password = urlencode($obj_settings->get_superadmin_option('saasappoint_paypal_api_password'));$saasappoint_paypal_signature = urlencode($obj_settings->get_superadmin_option('saasappoint_paypal_signature'));$saasappoint_currency = $obj_settings->get_superadmin_option('saasappoint_currency');$saasappoint_company_logo = "";$paypaltestmode = "off";$version = urlencode('109.0');$paypal_return_url = urlencode(SITE_URL.'includes/lib/saasappoint_register_paypal_ajax.php');$paypal_cancel_url = urlencode(SITE_URL);$currency_code = $saasappoint_currency;$payment_action = urlencode("SALE");$locale_code = 'US';$company_logo = $saasappoint_company_logo;if($company_logo!='') {		$site_logo = SITE_URL."assets/images/".$saasappoint_company_logo;}else{	$site_logo='';}$border_color = '343a40';$allow_note = 1;$obj_saasappoint_paypal = new saasappoint_paypal();if($paypaltestmode=='off'){	$obj_saasappoint_paypal->mode = '';  /* leave empty for 'Live' mode */}else{	$obj_saasappoint_paypal->mode = 'SANDBOX'; }	/*set basic name and value pairs for curl post*/$basic_NVP = array(				'VERSION'=>$version,				'USER'=>$saasappoint_paypal_api_username,				'PWD'=>$saasappoint_paypal_api_password,				'SIGNATURE'=>$saasappoint_paypal_signature,				'RETURNURL'=>$paypal_return_url,				'CANCELURL'=>$paypal_cancel_url,				'PAYMENTREQUEST_0_CURRENCYCODE'=>$currency_code,				'NOSHIPPING'=>1,				'PAYMENTREQUEST_0_PAYMENTACTION'=>$payment_action,				'LOCALECODE'=>$locale_code,				'CARTBORDERCOLOR'=>$border_color,				'LOGOIMG'=>$site_logo,				'ALLOWNOTE'=>1			);  if($saasappoint_paypal_guest_payment=='on'){	$basic_NVP['SOLUTIONTYPE']='Sole';	$basic_NVP['LANDINGPAGE']='Billing';}foreach($basic_NVP as $key => $value) {  $obj_saasappoint_paypal->pv .= "&$key=$value";}$cart_item_counter=0;	$obj_saasappoint_paypal->pv .= "&L_PAYMENTREQUEST_0_NAME$cart_item_counter=".$_SESSION["saasappoint_adminregister_detail"]["plan_name"];$obj_saasappoint_paypal->pv .= "&L_PAYMENTREQUEST_0_DESC$cart_item_counter=".$_SESSION["saasappoint_adminregister_detail"]["description"];		$obj_saasappoint_paypal->pv .= "&L_PAYMENTREQUEST_0_AMT$cart_item_counter=".$_SESSION["saasappoint_adminregister_detail"]["plan_rate"];		$obj_saasappoint_paypal->pv .= "&L_PAYMENTREQUEST_0_QTY$cart_item_counter=1";			$cart_item_counter++;$obj_saasappoint_paypal->pv .= "&PAYMENTREQUEST_0_ITEMAMT=".$_SESSION["saasappoint_adminregister_detail"]["plan_rate"];$obj_saasappoint_paypal->pv .= "&PAYMENTREQUEST_0_TAXAMT=0";$obj_saasappoint_paypal->pv .= "&PAYMENTREQUEST_0_AMT=".$_SESSION["saasappoint_adminregister_detail"]["plan_rate"];$obj_saasappoint_paypal->pp_method_name = 'SetExpressCheckout';  /*method name using for API call*/$resultarray = array();if(!isset($_GET["token"])) {	$response_array = $obj_saasappoint_paypal->paypal_nvp_api_call();	/*Respond according to message we receive from Paypal*/	if("SUCCESS" == strtoupper($response_array["ACK"]) || "SUCCESSWITHWARNING" == strtoupper($response_array["ACK"]))	{			if(strtoupper($obj_saasappoint_paypal->mode)=='SANDBOX') {			  $obj_saasappoint_paypal->mode = '.sandbox';			}			/*Redirect user to PayPal store with Token received.*/			$paypal_url ='https://www'.$obj_saasappoint_paypal->mode.'.paypal.com/cgi-bin/webscr?cmd=_express-checkout&token='.$response_array["TOKEN"].'';							$resultarray['status']='success';			$resultarray['value']=$paypal_url;			echo json_encode($resultarray);die();								 	}else{		$resultarray['status']='error';		$resultarray['value']=urldecode($response_array["L_LONGMESSAGE0"]);		echo json_encode($resultarray);die();				}}	if(isset($_GET["token"]) && isset($_GET["PayerID"])){	$token = $_GET["token"];	$payer_id = $_GET["PayerID"];		$obj_saasappoint_paypal->pv .= "&TOKEN=".urlencode($token)."&PAYERID=".urlencode($payer_id);	$obj_saasappoint_paypal->pp_method_name = 'DoExpressCheckoutPayment';  /*method name using for API call*/	$payment_response_array = $obj_saasappoint_paypal->paypal_nvp_api_call(); 	if("SUCCESS" == strtoupper($payment_response_array["ACK"]) || "SUCCESSWITHWARNING" == strtoupper($payment_response_array["ACK"])){ 			    $transaction_id = urldecode($payment_response_array["PAYMENTINFO_0_TRANSACTIONID"]);		   	    /** add business **/		$obj_businesses->business_type_id = $_SESSION["saasappoint_adminregister_detail"]['business_type_id'];		$obj_businesses->registered_on = $_SESSION["saasappoint_adminregister_detail"]["subscribed_date"];		$obj_businesses->status = "Y";		$business_id = $obj_businesses->add_business();				if(is_numeric($business_id)){			/** add admin **/			$obj_admins->business_id = $business_id;			$obj_admins->email = trim(strip_tags(mysqli_real_escape_string($conn, $_SESSION["saasappoint_adminregister_detail"]['email'])));			$obj_admins->password = md5($_SESSION["saasappoint_adminregister_detail"]['password']);			$obj_admins->firstname = filter_var($_SESSION["saasappoint_adminregister_detail"]['firstname'], FILTER_SANITIZE_STRING);			$obj_admins->lastname = filter_var($_SESSION["saasappoint_adminregister_detail"]['lastname'], FILTER_SANITIZE_STRING);			$obj_admins->phone = $_SESSION["saasappoint_adminregister_detail"]['phone'];			$obj_admins->address = filter_var($_SESSION["saasappoint_adminregister_detail"]['address'], FILTER_SANITIZE_STRING);			$obj_admins->city = filter_var($_SESSION["saasappoint_adminregister_detail"]['city'], FILTER_SANITIZE_STRING);			$obj_admins->state = filter_var($_SESSION["saasappoint_adminregister_detail"]['state'], FILTER_SANITIZE_STRING);			$obj_admins->country = filter_var($_SESSION["saasappoint_adminregister_detail"]['country'], FILTER_SANITIZE_STRING);			$obj_admins->zip = filter_var($_SESSION["saasappoint_adminregister_detail"]['zip'], FILTER_SANITIZE_STRING);			$obj_admins->image = "";			$obj_admins->status = "Y";			$admin_id = $obj_admins->add_admin();						if(is_numeric($admin_id)){				/** add subscription **/				$obj_subscriptions->business_id = $business_id;				$obj_subscriptions->admin_id = $admin_id;				$obj_subscriptions->plan_id = $_SESSION["saasappoint_adminregister_detail"]['plan_id'];				$obj_subscriptions->transaction_id = $transaction_id;				$obj_subscriptions->subscribed_on = $_SESSION["saasappoint_adminregister_detail"]["subscribed_date"];				$obj_subscriptions->expired_on = $_SESSION["saasappoint_adminregister_detail"]["exipred_date"];				$obj_subscriptions->joined_on = $_SESSION["saasappoint_adminregister_detail"]["subscribed_date"];				$obj_subscriptions->renewal = $_SESSION["saasappoint_adminregister_detail"]['renewal_type'];				$obj_subscriptions->payment_method = "paypal";				$added = $obj_subscriptions->add_subscription();				$obj_subscriptions->add_subscription_history();							if($added){										/** add default frequently discount **/					$obj_frequently_discount->business_id = $business_id;					$obj_frequently_discount->add_default_frequently_discount();											/** add default schedule **/					$obj_schedule->business_id = $business_id;					$obj_schedule->add_default_schedule();										/** add default settings **/					$obj_settings->business_id = $business_id;					$companyname = filter_var($_SESSION["saasappoint_adminregister_detail"]['companyname'], FILTER_SANITIZE_STRING);					$companyemail = trim(strip_tags(mysqli_real_escape_string($conn, $_SESSION["saasappoint_adminregister_detail"]['companyemail'])));					$companyphone = $_SESSION["saasappoint_adminregister_detail"]['companyphone'];					$companyaddress = filter_var($_SESSION["saasappoint_adminregister_detail"]['companyaddress'], FILTER_SANITIZE_STRING);					$companycity = filter_var($_SESSION["saasappoint_adminregister_detail"]['companycity'], FILTER_SANITIZE_STRING);					$companystate = filter_var($_SESSION["saasappoint_adminregister_detail"]['companystate'], FILTER_SANITIZE_STRING);					$companyzip = filter_var($_SESSION["saasappoint_adminregister_detail"]['companyzip'], FILTER_SANITIZE_STRING);					$companycountry = filter_var($_SESSION["saasappoint_adminregister_detail"]['companycountry'], FILTER_SANITIZE_STRING);										$settings_added = $obj_settings->add_default_settings(SITE_URL, $companyname, $companyemail, $companyphone, $companyaddress, $companycity, $companystate, $companyzip, $companycountry);										if($settings_added){						/** add default templates **/						$obj_templates->business_id = $business_id;						$obj_templates->add_default_email_sms_templates();													/** update SMS credit **/						$obj_settings->business_id = $business_id;						$obj_settings->update_option("saasappoint_sms_credit", $_SESSION["saasappoint_adminregister_detail"]["updated_sms_credit"]);												/* Set session values for logged in user */						unset($_SESSION['customer_id']);						unset($_SESSION['superadmin_id']);						unset($_SESSION["saasappoint_adminregister_detail"]);						$_SESSION['business_id'] = $business_id;						$_SESSION['admin_id'] = $admin_id;						$_SESSION['login_type'] = "admin";												header('location:'.SITE_URL.'backend/');					}				}			}		}	   	   	   	}}